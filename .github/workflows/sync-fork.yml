name: Sync Fork

on:
  # æ¯å¤©å®šæ—¶æ£€æŸ¥æ›´æ–°
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤© UTC 8 ç‚¹æ‰§è¡Œ

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆè¦†ç›–æœ¬åœ°ä¿®æ”¹ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

  # å½“ä¸Šæ¸¸ä»“åº“æœ‰æ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘
  repository_dispatch:
    types: [sync-upstream]

jobs:
  sync:
    runs-on: ubuntu-latest
    # åªåœ¨ fork çš„ä»“åº“ä¸­è¿è¡Œ
    if: github.repository != 'wu529778790/navhub.shenzjd.com'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # éœ€è¦å®Œæ•´çš„å†å²è®°å½•ä»¥ä¾¿åˆå¹¶
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add upstream remote
        run: |
          # æ·»åŠ ä¸Šæ¸¸ä»“åº“ï¼ˆåŸä»“åº“ï¼‰
          git remote add upstream https://github.com/wu529778790/navhub.shenzjd.com.git
          git fetch upstream

      - name: Check for updates
        id: check
        run: |
          # è·å–ä¸Šæ¸¸å’Œæœ¬åœ°çš„æœ€æ–°æäº¤
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          LOCAL_COMMIT=$(git rev-parse origin/main)

          echo "ä¸Šæ¸¸æäº¤: $UPSTREAM_COMMIT"
          echo "æœ¬åœ°æäº¤: $LOCAL_COMMIT"

          if [ "$UPSTREAM_COMMIT" = "$LOCAL_COMMIT" ]; then
            echo "upstream=behind" >> $GITHUB_OUTPUT
            echo "status=âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_OUTPUT
          else
            echo "upstream=behind" >> $GITHUB_OUTPUT
            echo "status=ğŸ”„ å‘ç°æ–°ç‰ˆæœ¬ï¼Œå‡†å¤‡åŒæ­¥" >> $GITHUB_OUTPUT
          fi

      - name: Sync from upstream
        if: steps.check.outputs.upstream == 'behind'
        run: |
          echo "å¼€å§‹åŒæ­¥ä¸Šæ¸¸æ›´æ–°..."

          # è·å–ä¸Šæ¸¸æœ€æ–°ä»£ç 
          git fetch upstream

          # æ£€æŸ¥æ˜¯å¦æœ‰å†²çª
          if git merge-base --is-ancestor upstream/main origin/main; then
            echo "æœ¬åœ°åœ¨ä¸Šæ¸¸ä¹‹åï¼Œéœ€è¦åˆå¹¶"
            git merge --no-edit upstream/main
          else
            echo "ä¸Šæ¸¸åœ¨æœ¬åœ°ä¹‹åï¼Œå¯ä»¥å¿«è¿›æˆ–åˆå¹¶"
            git merge --no-edit upstream/main
          fi

          echo "åŒæ­¥å®Œæˆï¼"

      - name: Handle merge conflicts
        if: failure()
        run: |
          echo "âš ï¸ æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼"
          echo ""
          echo "å†²çªæ–‡ä»¶ï¼š"
          git diff --name-only --diff-filter=U
          echo ""
          echo "è§£å†³æ–¹æ¡ˆï¼š"
          echo "1. æ‰‹åŠ¨è§£å†³å†²çª"
          echo "2. å®Œæˆåˆå¹¶æäº¤"
          echo "3. æ¨é€åˆ°ä½ çš„ä»“åº“"

          # å¦‚æœæ˜¯å¼ºåˆ¶åŒæ­¥æ¨¡å¼ï¼Œä½¿ç”¨ theirs ç­–ç•¥
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            echo "å¼ºåˆ¶åŒæ­¥æ¨¡å¼ï¼šä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬"
            git checkout --theirs .
            git add .
            git commit -m "fix: resolve conflicts using upstream version"
            echo "å·²ä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬è§£å†³å†²çª"
          else
            exit 1
          fi

      - name: Push changes
        if: success() && steps.check.outputs.upstream == 'behind'
        run: |
          # æ¨é€åˆ°ä½ çš„ä»“åº“
          git push origin main
          echo "âœ… å·²æ¨é€æ›´æ–°åˆ°ä½ çš„ä»“åº“"

      - name: Update Docker image (optional)
        if: success() && steps.check.outputs.upstream == 'behind'
        run: |
          echo "ğŸ’¡ æç¤ºï¼šå¦‚æœä½¿ç”¨ Docker éƒ¨ç½²ï¼Œè¯·é‡æ–°æ„å»ºé•œåƒ"
          echo ""
          echo "æ–¹æ³• 1: ä½¿ç”¨ Docker Hub"
          echo "  docker pull wu529778790/navhub:main"
          echo "  docker-compose up -d"
          echo ""
          echo "æ–¹æ³• 2: é‡æ–°æ„å»º"
          echo "  docker-compose build --no-cache"
          echo "  docker-compose up -d"

      - name: Create Sync Summary
        if: always()
        run: |
          echo "## åŒæ­¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "çŠ¶æ€: ${{ steps.check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³" >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    needs: sync
    runs-on: ubuntu-latest
    if: always() && github.repository != 'wu529778790/navhub.shenzjd.com'

    steps:
      - name: Notify result
        run: |
          echo "åŒæ­¥çŠ¶æ€: ${{ needs.sync.result }}"
          echo ""
          echo "å¦‚æœéœ€è¦æ‰‹åŠ¨æ“ä½œï¼Œè¯·æŸ¥çœ‹ GitHub Actions è¯¦ç»†æ—¥å¿—"
